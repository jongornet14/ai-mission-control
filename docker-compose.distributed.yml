# Generated docker-compose for distributed RL training
# Architecture: 1 Coordinator + 8 Workers
# Uses simple inheritance: DistributedWorker(BaseWorker)

services:
  coordinator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rl-coordinator
    environment:
      - PYTHONPATH=/workspace/project
      - CUDA_VISIBLE_DEVICES=""
      - NUM_WORKERS=8
    volumes:
      - ./distributed_shared:/workspace/distributed_shared
      - ./logs:/workspace/logs
      - .:/workspace/project
    working_dir: /workspace/project
    command: >
      python scripts/coordinator_entry.py
      --shared_dir /workspace/distributed_shared
      --num_workers 8
      --check_interval 30
    networks:
      - rl-training
    restart: unless-stopped

  worker-0:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rl-worker-0
    environment:
      - PYTHONPATH=/workspace/project
      - CUDA_VISIBLE_DEVICES=0
      - ENV=${ENV:-CartPole-v1}
      - WORKER_ID=0
    volumes:
      - ./distributed_shared:/workspace/distributed_shared
      - ./logs:/workspace/logs
      - .:/workspace/project
    working_dir: /workspace/project
    command: >
      python scripts/worker_entry.py
      --worker_id 0
      --shared_dir /workspace/distributed_shared
      --env ${ENV:-CartPole-v1}
      --max_episodes 1000
    networks:
      - rl-training
    depends_on:
      - coordinator
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]

  worker-1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rl-worker-1
    environment:
      - PYTHONPATH=/workspace/project
      - CUDA_VISIBLE_DEVICES=0
      - ENV=${ENV:-CartPole-v1}
      - WORKER_ID=1
    volumes:
      - ./distributed_shared:/workspace/distributed_shared
      - ./logs:/workspace/logs
      - .:/workspace/project
    working_dir: /workspace/project
    command: >
      python scripts/worker_entry.py
      --worker_id 1
      --shared_dir /workspace/distributed_shared
      --env ${ENV:-CartPole-v1}
      --max_episodes 1000
    networks:
      - rl-training
    depends_on:
      - coordinator
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]

  worker-2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rl-worker-2
    environment:
      - PYTHONPATH=/workspace/project
      - CUDA_VISIBLE_DEVICES=0
      - ENV=${ENV:-CartPole-v1}
      - WORKER_ID=2
    volumes:
      - ./distributed_shared:/workspace/distributed_shared
      - ./logs:/workspace/logs
      - .:/workspace/project
    working_dir: /workspace/project
    command: >
      python scripts/worker_entry.py
      --worker_id 2
      --shared_dir /workspace/distributed_shared
      --env ${ENV:-CartPole-v1}
      --max_episodes 1000
    networks:
      - rl-training
    depends_on:
      - coordinator
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]

  worker-3:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rl-worker-3
    environment:
      - PYTHONPATH=/workspace/project
      - CUDA_VISIBLE_DEVICES=0
      - ENV=${ENV:-CartPole-v1}
      - WORKER_ID=3
    volumes:
      - ./distributed_shared:/workspace/distributed_shared
      - ./logs:/workspace/logs
      - .:/workspace/project
    working_dir: /workspace/project
    command: >
      python scripts/worker_entry.py
      --worker_id 3
      --shared_dir /workspace/distributed_shared
      --env ${ENV:-CartPole-v1}
      --max_episodes 1000
    networks:
      - rl-training
    depends_on:
      - coordinator
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]

  worker-4:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rl-worker-4
    environment:
      - PYTHONPATH=/workspace/project
      - CUDA_VISIBLE_DEVICES=0
      - ENV=${ENV:-CartPole-v1}
      - WORKER_ID=4
    volumes:
      - ./distributed_shared:/workspace/distributed_shared
      - ./logs:/workspace/logs
      - .:/workspace/project
    working_dir: /workspace/project
    command: >
      python scripts/worker_entry.py
      --worker_id 4
      --shared_dir /workspace/distributed_shared
      --env ${ENV:-CartPole-v1}
      --max_episodes 1000
    networks:
      - rl-training
    depends_on:
      - coordinator
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]

  worker-5:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rl-worker-5
    environment:
      - PYTHONPATH=/workspace/project
      - CUDA_VISIBLE_DEVICES=0
      - ENV=${ENV:-CartPole-v1}
      - WORKER_ID=5
    volumes:
      - ./distributed_shared:/workspace/distributed_shared
      - ./logs:/workspace/logs
      - .:/workspace/project
    working_dir: /workspace/project
    command: >
      python scripts/worker_entry.py
      --worker_id 5
      --shared_dir /workspace/distributed_shared
      --env ${ENV:-CartPole-v1}
      --max_episodes 1000
    networks:
      - rl-training
    depends_on:
      - coordinator
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]

  worker-6:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rl-worker-6
    environment:
      - PYTHONPATH=/workspace/project
      - CUDA_VISIBLE_DEVICES=0
      - ENV=${ENV:-CartPole-v1}
      - WORKER_ID=6
    volumes:
      - ./distributed_shared:/workspace/distributed_shared
      - ./logs:/workspace/logs
      - .:/workspace/project
    working_dir: /workspace/project
    command: >
      python scripts/worker_entry.py
      --worker_id 6
      --shared_dir /workspace/distributed_shared
      --env ${ENV:-CartPole-v1}
      --max_episodes 1000
    networks:
      - rl-training
    depends_on:
      - coordinator
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]

  worker-7:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rl-worker-7
    environment:
      - PYTHONPATH=/workspace/project
      - CUDA_VISIBLE_DEVICES=0
      - ENV=${ENV:-CartPole-v1}
      - WORKER_ID=7
    volumes:
      - ./distributed_shared:/workspace/distributed_shared
      - ./logs:/workspace/logs
      - .:/workspace/project
    working_dir: /workspace/project
    command: >
      python scripts/worker_entry.py
      --worker_id 7
      --shared_dir /workspace/distributed_shared
      --env ${ENV:-CartPole-v1}
      --max_episodes 1000
    networks:
      - rl-training
    depends_on:
      - coordinator
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu]

networks:
  rl-training:
    driver: bridge

volumes:
  distributed_shared:
    driver: local
